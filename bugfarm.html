<!doctype html>
<html lang="en"><head>
    <!-- Bootstrap-required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<!--        
    <title>id:xtable</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"  crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js" integrity="sha256-bQmrZe4yPnQrLTY+1gYylfNMBuGfnT/HKsCGX+9Xuqo=" crossorigin="anonymous"></script>

    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jplayer/2.9.2/jplayer/jquery.jplayer.min.js'></script>
    <script type='text/javascript' src='/static/js/sound.js'></script>
    <link rel="stylesheet" media="screen" type="text/css" href="/static/js/colorpicker/css/colorpicker.css" />
    <script type="text/javascript" src="/static/js/colorpicker/js/colorpicker.js"></script>
-->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"  crossorigin="anonymous"></script>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.js'></script>
</head><body>

<!-- CSS styling -->
<style type='text/css'>
:root {
    --main-bg-color: lightgrey;
    --main-fg-color: white;
}
body, a {
    font-family: Sans-Serif;
    color: white !important;
    background-color: var(--main-bg-color);
}
</style>

<div id='app'>
    <div id='header'></div>
    <div id='content'>
        <div id='canvas'></div>
    </div>
    <div id='footer'></div>
</div>

<script type='text/javascript'>

const paper_width = 1024;
const paper_height = 1024;
const num_bugs = 200;
const max_v = 1;

var paper;
var bugs = [];
var links = {};
var link_elements = {};

$(document).ready(function() {
    console.log('Bug Farm here!');
    paper = Raphael(0, 0, paper_width, paper_height);

    for (var i=0; i < num_bugs/2; i++) {
        bugs.push(BlueBug(i));
    }
    for (var i=num_bugs/2; i < num_bugs; i++) {
        bugs.push(RedBug(i));
    }
    bugs[0].becomeInfected();
    bugs[num_bugs-1].becomeInfected();

    for (var l=0; l < 0; l++) {
        addLink(randomBug(), randomBug());
    }

    window.setInterval(tick, 50);
});

function tick() {
    for (var b=0; b < num_bugs; b++) {
        bugs[b].tick();
    }
    updateLinks();
}

function randomBug() {
    return Math.floor(Math.random() * num_bugs)
}

function linkKey(i, j) {
    return '' + Math.min(i, j) + '-' + Math.max(i, j);
}

function linkPath(i, j) {
    return [
        'M', bugs[i].x.toString(), ' ', bugs[i].y.toString(),
        'L', bugs[j].x.toString(), ' ', bugs[j].y.toString()
    ].join('');  
}

function addLink(i, j, color) {
    if (Object.keys(links).length >= 100) return;
    const key = linkKey(i, j);
    if (key in links) return;
    links[key] = [i, j];
    const link_element = paper.path(linkPath(i, j));
    link_element.attr('stroke', color || 'gray');
    link_elements[key] = link_element;
}

function updateLinks() {
    for (var l in links) {
        link_elements[l].attr('path', linkPath(links[l][0], links[l][1]));
    }
}

function BlueBug(id) {
    return new Bug({
        id: id,
        faction: 'blue',
        color: 'blue',
        motion_multiplier: 0.5,
        protection_multiplier: 0.90
    });
}

function RedBug(id) {
    return new Bug({
        id: id,
        faction: 'red',
        color: 'red',
        motion_multiplier: 1.0,
        protection_multiplier: 0.1
    });
}

function Bug(options) {

    this.init = function(options) {
        console.log('init bug:', options);
        this.r = 5;
        this.infected = 0;
        this.color = 'gray';
        this.fill = 'white';
        this.home_x = this.x = Math.random() * paper_width/2;
        this.home_y = this.y = Math.random() * paper_height;
        this.moving = 10000;
        this.motion_multiplier = 1.0;
        this.protection_multiplier = 1.0;
        this.dx = Math.random() * 2 * max_v - max_v;
        this.dy = Math.random() * 2 * max_v - max_v;
        for (var o in options) this[o] = options[o];
        if (this.faction == 'red') this.home_x = this.x = paper_width - this.x;
        this.elts = [];
        this.render();
        return this;
    };

    this.tick = function() {
        this.move();
        this.infect();
    };

    this.render = function() {
        var circle = paper.circle(this.x, this.y, this.r);
        circle.attr({
            stroke: this.color,
            //'stroke-opacity': 1.0,
            'fill-opacity': 1.0,
            'stroke-width': 3,
            fill: this.fill
        });
        this.elts.push(circle);
    };

    this.move = function() {
        if (this.moving <= 0) return;
        this.moving--;

        // slime trails
        if (this.infected && ((this.moving % 10) == 0)) {
            const slime = paper.circle(this.x, this.y, 1);
            slime.attr('stroke', this.infection_color);
        }

        this.x += this.dx * this.motion_multiplier;
        if (this.x > paper_width) {
            this.dx = -this.dx;
            this.x = paper_width - (this.x - paper_width);
        }
        else if (this.x < 0) {
            this.dx = -this.dx;
            this.x = -this.x;
        }

        this.y += this.dy * this.motion_multiplier;
        if (this.y > paper_height) {
            this.dy = -this.dy;
            this.y = paper_height - (this.y - paper_height);
        }
        else if (this.y < 0) {
            this.dy = -this.dy;
            this.y = -this.y;
        }

        for (var e in this.elts) {
            this.elts[e].attr({'cx': this.x, 'cy': this.y});
        }
    };

    this.distanceTo = function(b) {
        return Math.sqrt((this.x - bugs[b].x) ** 2 + (this.y - bugs[b].y) ** 2);
    };

    this.infect = function() {
        for (var b in bugs) {
            if (b == this.id) continue;
            const distance = this.distanceTo(b);
            if (distance < (2 * this.r)) {
                if (this.infected && !bugs[b].infected) {
                    if (Math.random() > bugs[b].protection_multiplier) {
                        bugs[b].becomeInfected(this.infection_color);
                        addLink(this.id, b);
                    }
                }
                else if (bugs[b].infected && !this.infected) {
                    if (Math.random() > this.protection_multiplier) {
                        this.becomeInfected(bugs[b].infection_color);
                        addLink(this.id, b);
                    }
                }
            }
        }
    };

    this.becomeInfected = function(infection_color) {
        this.infected = 1;
        this.infection_color = infection_color || this.color;
        for (var e in this.elts) {
            this.elts[e].attr({fill: 'black'});
        }
    };

    return this.init(options || {});
}

</script>
</body>
</html>